<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Prospect Bookstore</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="index.css" />
</head>
<body>

<nav class="navbar navbar-light bg-light px-4">
    <a class="navbar-brand" href="#">Prospect BookStore</a>
    <div class="d-flex gap-2">
        <a href="registration.html" class="btn btn-outline-primary">Register</a>
        <a href="login.html" class="btn btn-outline-secondary">Login</a>
    </div>
</nav>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-4">
            <form id="searchForm" role="search">
                <div class="position-relative">
                    <input
                            type="search"
                            id="searchQuery"
                            name="q"
                            class="form-control rounded-pill border-primary"
                            placeholder="Search"
                            aria-label="Search"
                            required
                    >
                    <span class="input-group-icon" id="searchButton">
                        <i class="bi bi-search text-primary"></i>
                    </span>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="container mt-5">
    <div id="bookCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner">
            <!-- Books will be inserted here -->
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#bookCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#bookCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>
    </div>
</div>

<!-- Book Detail Modal -->
<div class="modal fade" id="bookDetailModal" tabindex="-1" aria-labelledby="bookDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookDetailModalLabel">Book Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <img id="bookDetailImage" src="" alt="" class="book-detail-image">
                </div>
                <h3 id="bookDetailTitle" class="text-center mb-3"></h3>
                <h5 id="bookDetailAuthor" class="text-center mb-4"></h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <p class="book-meta"><strong>Publisher:</strong> <span id="bookDetailPublisher"></span></p>
                        <p class="book-meta"><strong>Published Date:</strong> <span id="bookDetailPublishedDate"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p class="book-meta"><strong>Page Count:</strong> <span id="bookDetailPageCount"></span></p>
                        <p class="book-meta"><strong>Genres:</strong> <span id="bookDetailGenres"></span></p>
                    </div>
                </div>
                
                <div id="bookDetailDescription" class="book-description mt-4"></div>
                
                <div class="text-center">
                    <a id="bookDetailPreviewLink" href="#" target="_blank" class="btn btn-primary book-preview-link">Preview Book</a>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS and Popper.js -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Book detail modal instance
    let bookDetailModal;
    
    // Function to fetch books from our backend API
    async function fetchBooks(query = 'bestsellers') {
        try {
            const response = await fetch(`/api/books/search?query=${encodeURIComponent(query)}`);
            const books = await response.json();
            return books || [];
        } catch (error) {
            console.error('Error fetching books:', error);
            return [];
        }
    }

    // Function to create carousel items
    function createCarouselItems(books) {
        const carouselInner = document.querySelector('.carousel-inner');
        carouselInner.innerHTML = '';

        // Show a message if no books found
        if (books.length === 0) {
            const emptyMessage = document.createElement('div');
            emptyMessage.className = 'carousel-item active';
            emptyMessage.innerHTML = `
                <div class="d-flex justify-content-center align-items-center h-100">
                    <h3>No books found. Try a different search.</h3>
                </div>
            `;
            carouselInner.appendChild(emptyMessage);
            return;
        }

        books.forEach((book, index) => {
            const carouselItem = document.createElement('div');
            carouselItem.className = `carousel-item ${index === 0 ? 'active' : ''}`;
            
            carouselItem.innerHTML = `
                <div class="book-slide">
                    <img src="${book.imageUrl}" alt="${book.title}">
                    <div class="book-title">${book.title}</div>
                    <div class="book-author">by ${book.authorUsername ? book.authorUsername.join(', ') : 'Unknown Author'}</div>
                </div>
            `;
            
            // Add click event to open the modal with book details
            const bookSlide = carouselItem.querySelector('.book-slide');
            bookSlide.addEventListener('click', () => openBookDetail(book));
            
            carouselInner.appendChild(carouselItem);
        });
    }

    // Function to open book detail modal
    function openBookDetail(book) {
        // Set modal content
        document.getElementById('bookDetailModalLabel').textContent = book.title;
        document.getElementById('bookDetailImage').src = book.imageUrl;
        document.getElementById('bookDetailImage').alt = book.title;
        document.getElementById('bookDetailTitle').textContent = book.title;
        document.getElementById('bookDetailAuthor').textContent = `by ${book.authorUsername ? book.authorUsername.join(', ') : 'Unknown Author'}`;
        document.getElementById('bookDetailPublisher').textContent = book.publisher || 'Unknown';
        document.getElementById('bookDetailPublishedDate').textContent = book.publishedDate || 'Unknown';
        document.getElementById('bookDetailPageCount').textContent = book.pageCount ? `${book.pageCount} pages` : 'Unknown';
        document.getElementById('bookDetailGenres').textContent = book.genre && book.genre.length > 0 ?
            book.genre.join(', ') : 'Unknown';
        document.getElementById('bookDetailDescription').innerHTML = book.description || 'No description available';
        
        const previewLink = document.getElementById('bookDetailPreviewLink');
        if (book.previewLink) {
            previewLink.href = book.previewLink;
            previewLink.style.display = 'inline-block';
        } else {
            previewLink.style.display = 'none';
        }
        
        // Show the modal
        bookDetailModal.show();
    }

    // Initialize the carousel with books
    async function initializeCarousel() {
        const books = await fetchBooks();
        createCarouselItems(books);
    }

    // Handle search form submission
    document.getElementById('searchForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        const query = document.getElementById('searchQuery').value.trim();
        if (query) {
            const books = await fetchBooks(query);
            createCarouselItems(books);
        }
    });
    
    // Handle search icon click
    document.getElementById('searchButton').addEventListener('click',async function(event) {
        event.preventDefault();
        const searchForm = document.getElementById('searchForm');
        const searchQuery = document.getElementById('searchQuery').value.trim();

        if (searchQuery) {
            const books = await fetchBooks(searchQuery);
            createCarouselItems(books);
        }
    });
    
    // Initialize everything when the page loads
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize the modal
        bookDetailModal = new bootstrap.Modal(document.getElementById('bookDetailModal'));
        const urlParams = new URLSearchParams(window.location.search);
        const initialQuery = urlParams.get('q') || 'bestsellers';
        // Load books with an initial query
        fetchBooks(initialQuery).then(createCarouselItems);
    });
</script>
</body>
</html>